<div class="mt-8 mb-4 px-6">
	<app-page-title title="Quote calculator"></app-page-title>
</div>

<!-- Calculation Form -->
<form
	[formGroup]="budgetForm"
	class="flex flex-col items-start gap-4 bg-white border rounded-lg shadow-sm shadow-slate-300/50"
	method="post"
	spellcheck="false"
>
	<!-- Workers Form -->
	<div class="flex justify-between items-center px-6 py-4 border-b w-full">
		<h2 class="text-lg font-semibold">Workers</h2>

		<button
			class="flex items-center h-8 px-2 transition-colors rounded-l font-semibold text-sm text-emerald-600 hover:bg-emerald-50/75"
			type="button"
			(click)="addWorker()"
		>
			<svg viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 -ml-2">
				<path
					d="M10.75 6.75a.75.75 0 00-1.5 0v2.5h-2.5a.75.75 0 000 1.5h2.5v2.5a.75.75 0 001.5 0v-2.5h2.5a.75.75 0 000-1.5h-2.5v-2.5z"
				/>
			</svg>

			<span>Add Worker</span>
		</button>
	</div>

	<div class="flex flex-col gap-2 px-6 items-start">
		<!-- Headers -->
		<div class="flex gap-2">
			<div class="w-48 text-sm font-semibold">Time worked</div>
			<div class="w-24 text-sm font-semibold">Units</div>
			<div class="w-24 text-sm font-semibold">Pay grade</div>
		</div>

		<!-- Rows -->
		<div
			formArrayName="workers"
			class="flex flex-col gap-2 pr-2 overflow-x-hidden overflow-y-auto max-h-64"
		>
			<ng-container
				*ngFor="
					let workerForm of budgetForm.controls['workers'].controls;
					let i = index
				"
			>
				<div [formGroup]="workerForm" class="flex gap-2">
					<input
						class="w-48 h-8 px-2 text-sm border rounded focus:z-10"
						formControlName="timeWorked"
						type="number"
						placeholder="36"
						min="1"
						required
					/>

					<select
						class="w-24 h-8 px-2 text-sm border rounded cursor-pointer"
						formControlName="timeUnit"
					>
						<option *ngFor="let unit of timeUnits" [value]="unit">
							{{ unit | titlecase }}
						</option>
					</select>

					<select
						class="w-24 h-8 px-2 text-sm border rounded-md cursor-pointer"
						formControlName="payGrade"
						required
					>
						<option *ngFor="let grade of payGrades" [value]="grade">
							{{ grade | titlecase }}
						</option>
					</select>

					<app-x-button *ngIf="i > 0" (click)="removeWorker(i)"></app-x-button>
				</div>
			</ng-container>
		</div>
	</div>

	<!-- One-off Costs Form -->

	<div class="flex justify-between items-center px-6 py-4 border-y w-full">
		<h2 class="text-lg font-semibold">One-off Costs</h2>

		<button
			class="flex items-center h-8 px-2 transition-colors rounded-l font-semibold text-sm text-emerald-600 hover:bg-emerald-50/75"
			type="button"
			(click)="addOneOffCost()"
		>
			<svg viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
				<path
					d="M10.75 6.75a.75.75 0 00-1.5 0v2.5h-2.5a.75.75 0 000 1.5h2.5v2.5a.75.75 0 001.5 0v-2.5h2.5a.75.75 0 000-1.5h-2.5v-2.5z"
				/>
			</svg>

			<span>Add Item</span>
		</button>
	</div>

	<div
		*ngIf="budgetForm.controls['oneOffCosts'].controls.length"
		class="flex flex-col gap-2 px-6 items-start"
	>
		<!-- Headers -->
		<div class="flex gap-2">
			<div class="w-48 text-sm font-semibold">Item name</div>
			<div class="w-24 text-sm font-semibold">Cost</div>
		</div>

		<!-- Rows -->
		<div
			formArrayName="workers"
			class="flex flex-col gap-2 pr-2 overflow-x-hidden overflow-y-auto max-h-64"
		>
			<ng-container
				*ngFor="
					let oneOffCostForm of budgetForm.controls['oneOffCosts'].controls;
					let i = index
				"
			>
				<div [formGroup]="oneOffCostForm" class="flex gap-2">
					<input
						class="w-48 h-8 px-2 text-sm border rounded focus:z-10"
						formControlName="itemName"
						type="text"
						placeholder="E.g. desk"
						maxlength="64"
						required
					/>

					<input
						class="w-48 h-8 px-2 text-sm border rounded focus:z-10"
						formControlName="cost"
						type="number"
						placeholder="£"
						min="1"
						required
					/>

					<app-x-button (click)="removeOneOffCost(i)"></app-x-button>
				</div>
			</ng-container>
		</div>
	</div>

	<!-- Ongoing Costs Form -->

	<div class="flex justify-between items-center px-6 py-4 border-y w-full">
		<h2 class="text-lg font-semibold">Ongoing Costs</h2>

		<button
			class="flex items-center h-8 px-2 transition-colors rounded-l font-semibold text-sm text-emerald-600 hover:bg-emerald-50/75"
			type="button"
			(click)="addOngoingCost()"
		>
			<svg viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
				<path
					d="M10.75 6.75a.75.75 0 00-1.5 0v2.5h-2.5a.75.75 0 000 1.5h2.5v2.5a.75.75 0 001.5 0v-2.5h2.5a.75.75 0 000-1.5h-2.5v-2.5z"
				/>
			</svg>

			<span>Add Item</span>
		</button>
	</div>

	<div
		*ngIf="budgetForm.controls['ongoingCosts'].controls.length"
		class="flex flex-col gap-2 px-6 items-start"
	>
		<!-- Headers -->
		<div class="flex gap-2">
			<div class="w-64 text-sm font-semibold">Item name</div>
			<div class="w-24 text-sm font-semibold">Cost</div>
			<div class="w-24 text-sm font-semibold">How many</div>
			<div class="w-24 text-sm font-semibold">How often</div>
		</div>

		<!-- Rows -->
		<div
			formArrayName="workers"
			class="flex flex-col gap-2 pr-2 overflow-x-hidden overflow-y-auto max-h-64"
		>
			<ng-container
				*ngFor="
					let ongoingCostForm of budgetForm.controls['ongoingCosts'].controls;
					let i = index
				"
			>
				<div [formGroup]="ongoingCostForm" class="flex gap-2">
					<input
						class="w-64 h-8 px-2 text-sm border rounded focus:z-10"
						formControlName="itemName"
						type="text"
						placeholder="E.g. desk"
						maxlength="64"
						required
					/>

					<input
						class="w-24 h-8 px-2 text-sm border rounded focus:z-10"
						formControlName="cost"
						type="number"
						placeholder="£"
						min="1"
						required
					/>

					<input
						class="w-24 h-8 px-2 text-sm border rounded focus:z-10"
						formControlName="amount"
						type="number"
						min="1"
						required
					/>

					<select
						class="w-24 h-8 px-2 text-sm border rounded cursor-pointer"
						formControlName="frequency"
					>
						<option *ngFor="let unit of frequencies" [value]="unit">
							{{ unit | titlecase }}
						</option>
					</select>

					<app-x-button (click)="removeOngoingCost(i)"></app-x-button>
				</div>
			</ng-container>
		</div>
	</div>

	<div class="px-6 py-4 border-y w-full">
		<button
			class="flex items-center justify-center h-8 gap-1 px-8 transition-colors rounded text-slate-50 bg-emerald-600 hover:bg-emerald-600/75 active:bg-emerald-700"
			type="button"
			(click)="submitForm()"
		>
			<span class="text-sm font-semibold">Calculate</span>
		</button>
	</div>
</form>

<!-- Calculation Output -->
<div *ngIf="quote$ | async as quote" class="px-4 py-6">
	<div class="flex flex-col">
		<h2 class="text-gray-500">Estimated budget</h2>
		<div class="text-4xl">{{ quote | currency : 'GBP' }}</div>
	</div>

	<ng-container *ngIf="isLoggedIn$ | async">
		<div class="my-4">
			<button
				(click)="saveQuote()"
				type="button"
				class="flex items-center gap-2 p-2 border rounded"
			>
				<ng-container *ngIf="currentQuote$ | async; else saveQuoteIcon">
					<svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
						<path
							fill-rule="evenodd"
							d="M6.32 2.577a49.255 49.255 0 0111.36 0c1.497.174 2.57 1.46 2.57 2.93V21a.75.75 0 01-1.085.67L12 18.089l-7.165 3.583A.75.75 0 013.75 21V5.507c0-1.47 1.073-2.756 2.57-2.93z"
							clip-rule="evenodd"
						/>
					</svg>

					Quote saved
				</ng-container>

				<ng-template #saveQuoteIcon>
					<svg
						fill="none"
						viewBox="0 0 24 24"
						stroke-width="1.5"
						stroke="currentColor"
						class="w-6 h-6"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z"
						/>
					</svg>

					Save this quote
				</ng-template>
			</button>
		</div>
	</ng-container>
</div>

<!-- "Sign in to save quote" -->
<ng-container *ngIf="!(isLoggedIn$ | async)">
	<app-user-notice></app-user-notice>
</ng-container>

<!-- Quote saving dialog -->
<app-dialog header="Enter a project name">
	<app-save-quote-dialog></app-save-quote-dialog>
</app-dialog>
